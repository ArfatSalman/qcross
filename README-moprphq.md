
# MorphQ software

The MorphQ software is open source and you find all the relevant source files in the [lib](lib) folder.

You can run MorphQ with two objectives:
1. [Replication Package Level 1](#Getting-started): reproduce paper's results.
2. [Replication Package Level 2](#Run-your-own-Testing-Campaigns): run new testing campaigns to find new bugs in Qiskit.

# Getting started
**Replication Package Level 1**

## Setup Environment

We provide the `environment.yml` file in the main folder to recreate the exact Conda environment with the same pip and Conda packages.
(Download Conda for your system [here](https://docs.conda.io/projects/conda/en/latest/user-guide/install/download.html))
Run the following command:
```bash
conda env create -f environment.yml
```
Then activate the environment with:
```bash
conda activate MorphQ
```

## Reproduce the Paper figures

Follow this steps:
1. Download the datasets used in our evaluation section from this [link](https://figshare.com/s/dd0d4af20fd6e06148a3).

2. copy the folders `qmt_v52` and `qmt_v53` in the `data` directory.

3. Execute top to bottom all cells of the notebook: [notebooks/RQs_Reproduce_Analysis_Results.ipynb](notebooks/RQs_Reproduce_Analysis_Results.ipynb).

## Inspect the Warnings found during our Empirical Evaluation
To see the warnings described in our empirical evaluation of the paper refer to the [`warnings/program_pairs`](warnings/program_pairs) folder.
There you will find a subfolder for each program pairs which contains:
- the source quantum program: `source.py`
- the follow-up quantum program generated via metamorphic transformations: `follow-up.py`
- the metadata of the generation of the program pair: `metadata.json`
- the metadata of the execution of the program pair: `metadata_exec.json`
- an anonymized screenshot of the issue page: `program_code.pdf`


# Run your own Testing Campaigns
**Replication Package Level 2**

The following guide helps you preparing the setting of your MorphQ run and start the test of Qiskit platform.

## Data Folder
Before starting the test, we need to decide where to store the data.
Typically, we recommend to create a new subfolder in the `data` directory, following the name convention: `qmt_vXX` where XX is the version of your run or specific configuration settings.
Note that this step is required to be sure that the folder is available since the beginning, so that we can also store the log of our run.

## MorphQ Settings
Before starting your test run, you need to prepare some configuration files in the data [`config`](config) folder.

1. create a `qmt_vXX.yaml` file in the `config` folder. On this file you can set almost all the parameters of the test. Including the metamorphic relationships to use (via the `metamorphic_strategies` field) and the program generation mechanism (via the `generation_strategy` field).

**IMPORTANT**: Remember to update the two field: `experiment_folder` to point to the data folder (e.g., `data/qmt_vXX/`) and `coverage_settings_filepath` to point to the file containing the coverage settings (e.g., `config/qmt_vXX.cover`).

2. create a `qmt_vXX.cover` file in the `config` folder. On this file you can set the coverage settings.

**IMPORTANT**: update the `data_file` field to specify the final name of the coverage database in the correct data folder (e.g., `data/qmt_vXX/.coverage`).

3. (optional) to avoid that the generated programs are processed by the git installation add the data folder to your `.gitignore` file.
```
data/qmt_vXX/*
```

## Run MorphQ
To run `MorphQ` use the following command:
```bash
screen -L -Logfile data/qmt_vXX/log_run.txt -S qmt_vXX python3 -m lib.qmt config/qmt_vXX.yaml
```

## Inspect Warnings of your run

Here we describe where to find and how to inspect the warnings generated by `MorphQ`.

The relevant warnings of your run will be stored in a the `qfl.db` sqlite database in the `data/qmt_vXX/` folder.
To inspect them use the notebook [`notebooks/Demo_Warnings_Manual_Inspection.ipynb`](notebooks/Demo_Warnings_Manual_Inspection.ipynb).


# Troubleshooting
Some questions you might ask yourself are:
1. Did you install and activate the conda environment? via `conda activate MorphQ`

## Our Hardware Setup
We tested MorphQ with the following setup:

- Operating System: Ubuntu 18.04.6 LTS
- Linux version 4.15.0-167-generic
- Architecture: x86-64
- CPU: Intel(R) Xeon(R) Silver 4214 CPU @ 2.20GHz
- conda 4.11.0
- RAM: 252 GB